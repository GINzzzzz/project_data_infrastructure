# project_data_infrastructure
Базы данных и процедуры хранения и обработки данных для проектов транспортного планирования.

- [принципиальные замечания](#titl0);
- [верхний уровень](#titl1);
- [нижний уровень](#titl2);

Основная задача:
- создание единого рабочего пространства: информация в ходе разработки должна быть доступна в актуальной на данный момент версии без необходимости дополнительных запросов исполнителям.
В особенности, это касается программ мероприятий. Актуальной считается версия программы мероприятий по проекту, которая на данный момент находится в проектной БД в таблице action_plan. По ней рассчитываются показатели и финансовые затраты. ОНИ ЖЕ УХОДЯТ на моделирование и в ГИС.
Проекты ГИС (таблицы слоев) тоже хранятся на сервере в БД проекта и синхронизируются с программой через атвоматизированный UPDATE. Все ГИС-слои проекта в составе отчетной документации должны быть загружены на сервер. ГИС-слои мероприятий должны иметь единую семантику для обновления единым запросом.

Обновление: в составе проекта должны иметься 6 основных слоев. В схеме sushpol - существующие объекты. В схеме meropriyatia - перспективные объекты. В каждой схеме 3 слоя - точечные объекты, линейные объекты и площадные объекты. Все остальное максимально решать геоаналитикой и виртуальными слоями.

## <a id="titl0">Принципы</a>
- двухуровневая организация хранения данных на сервере: (1) данные верхнего уровня, включая объекты федерального и межрегионального значения, административные данные и справочники; (2) проектные данные,    
  связанные с разработкой конкретного проекта;
- уникальность объекта / маршрута / мероприятия - три сущности должны иметь УИН в рамках всей системы хранения (так как они повторяются на 2 уровнях и между проектами):
  т.е. у строк данных в их случае 2 УИНа -  (1) id строки в рамках таблицы данных (автоматически через serial),
                                            (2) УИН строки в рамках системы, назначаемой полуавтоматически (на стадии загрузки данных к индексу добавляются системные идентификаторы БД и таблицы).
                                                **ЭТОТ НОМЕР НЕ ДОЛЖЕН МЕНЯТЬСЯ НИКОГДА, ПОКА ОБЪЕКТ / МАРШРУТ / МЕРОПРИЯТИЕ ХРАНЯТСЯ**;
- минимальные ограничения на внесение данных на стороне БД (т.е. ограничения только по типу данных, и значения по-умолчанию только для id строк (тип serial), d_reg (CURRENT DATE для фиксации даты внесения 
  строки в таблицу) - все проверки и ограничения реализуем на стороне бэкенда (загрузчика);
- закрытый базовый перечень данных: основная структура баз данных ограничена нижеописанными таблицами (также см. диаграмму) - это позволит быстрее выйти на потоковую загрузку данных, т.к. загрузчик будет 
  реализовывать процедуры и условия, заданные семантикой конкретной таблицы, другие таблицы загружать возможно, но уже без проверок (2 загрузчика?);
- хранение минимальных единиц данных: хранятся только базовые единицы информации - объекты, маршруты, транспортные средства, меропряития с основными параметрами (все расчетные показатели не хранятся в базе, но 
  решаются через запросы и представления).

  Обновление: в таблицы вводятся такие сущности как группирующие строки (связка через id_parent). Это противоречит логике БД, т.к. они содержат в себе информацию, которая уже содержится в той же таблице.
  Но они нужны, чтобы избежать ошибок при расчете затрат и показателей (напр., при разделении строки на источники финанансирования могут продублироваться физические параметры и стоимости, что задвоит 
  показатели). Также облегчает восприятие информации, т.к. сразу содержит сводную информацию о входящих объектах. Абсолютно необходимы для создания ГИС-слоев, т.к. цифровка в ГИС может осуществляться не по 
  комплексному объекту, а по его составной части (аэропорт и аэродром - это 2 разных объекта, но в ГИС вносятся как один комплекс - тогда привязка осуществляется к УИН группирующей строки).
  Сложность - необходим автоматизированный UPDATE группировок с учетом правок (чтобы исключить ошибки при расчете сводных показателей после внесения изменений в данные).
  
- данные (по большей части) загружаются и выгружаются с использованием библиотеки pandas (обновление - версия 1.5.0);
- разделение ролей: загрузка данных в проектные БД осуществляется пользователем с ролью trplanner (кроме суперпользователей), в генеральную БД - только суперпользователем.

## <a id="titl1">Верхний уровень - Генеральная база данных</a>
- [x] 1) таблица infra_objects: объекты транспортной инфраструктуры федерального значения, международные терминалы транспорта;
   Для внесения существующих объектов. В рамках перечня ОТИ понимать как объект с уникальными: нормативным установленным классом (категорией), линейными или площадными параметрами мощности.
   В качестве резервного варианта для объектов с неопределенными характеристиками предусмотрены количественные параметры (по типу Транспортная развязка - 1 ед.), но лучше вносить конкретные параметры.
   Также для каждого ОТИ необходимо наличие характеристик транспортной и/или пассажирской/грузовой пропускной способности и/или емкости (или потенциальная возможность их установить).
   Известные источники:
   - Перечень федеральных дорог - Постановление Правительства РФ от 17.11.2010 N 928 (ред. от 14.06.2023) (https://rosavtodor.gov.ru/docs/ofitsialnye-dokumenty/12217);
   - Государственный реестр аэродромов и вертодромов гражданской авиации Российской Федерации (https://favt.gov.ru/dejatelnost-ajeroporty-i-ajerodromy-reestr-grajdanskih-ajerodromov-rf/);
   - Объемы перевозок через аэропорты России (https://favt.gov.ru/dejatelnost-ajeroporty-i-ajerodromy-osnovnie-proizvodstvennie-pokazateli-aeroportov-obyom-perevoz/);
   - Объемы перевозок через аэропорты МАУ (https://favt.gov.ru/dejatelnost-ajeroporty-i-ajerodromy-osnovnie-proizvodstvennie-pokazateli-aeroportov-obyomy-mau/);
   - Перечень морских портов Российской Федерации, в которых осуществляет деятельность ФГУП «Росморпорт» (https://www.rosmorport.ru/services/seaports/);
   - Речные порты??? (открытый источник - перечень 2008 г., однако есть распоряжение ППРФ об открытых портах, и там другие порты есть)
- [x] 2) таблица ptv_routes: межрегиональные маршруты транспорта общего пользования, авиационные региональные маршруты и поезда дальнего следования согласно открытым реестрам и перечням;
   Для внесения межрегиональных маршрутов и установленных маршрутов ОПТ, которые связывают между собой субъекты РФ, в первую очередь.
   Официально существуют реестры автобусных и субсидируемых маршрутов. Поезда дальнего следования единым перечнем в открытом доступе отсутствуют.
   Источник:
   - Реестр межрегиональных маршрутов: в документах Минтранса по словам Реестр межрегиональных маршрутов;
   - Авиация: перечень субсидируемых маршрутов в рамках ППРФ от 25.12.2013 № 1242 (https://favt.gov.ru/dejatelnost-vozdushnye-perevozki-subsidirovanie-regiony/);
- [x] 3) таблица ptv_vehs: по сути, таблица-приложение к таблице ptv_threads (связка через УИН маршрутов), содержащая информацию о подвижном составе, обслуживающем маршруты в составе ptv_threads;
   Для внесения данных о подвижном составе на маршрутах ОПТ. Разделение обеспечит относительно свободное формирование данных о ПС (внести данные можно, в совокупности, по классам ПС, а можно по каждой единице).
   Также позволяет привязывать данные о каком-то наборе транспортных средств к нескольким маршрутам (необходимо при внесении данных о разных вариантах одного маршрута).
   Каждый вариант маршрута вносится отдельной строкой в таблицу маршрутов ptv_routes. Но строка ПС остается одной для обеих строк, и при сведении результатов нет необходимости отслеживать дублирование ПС.
4) таблицы-справочники: классификаторы объектов и отдельных параметров:
   - [x] таблица tobjects: классификатор объектов инфраструктуры и маршрутов (используется для определения типа вносимого объекта и маршрута;
         Нужна для однозначного определения типов ОТИ в составе документов и программ. Типы ОТИ кодируются в числовом формате.
   - [x] таблица fuel_types: типы топлива для использования в таблицах ptv_vehs;
         Однозначное определение типов используемого топлива. В основном, для решения вопросов экологии в проектах.
   - [x] таблица fin_levels: источники финансирования для определения источника финансирования мероприятий;
         Однозначное определение источников финансирования. Необходимо для сведения итоговых расходов по источникам финансирования.
         Также код из fin_levels может использоваться в проектной таблице мероприятий как номер строки 3-го уровня нумерации;
   - [x] таблица codes_regions: коды ОКАТО и ГРЗ для идентификации субъектов РФ;
         Информация о субъекте РФ, где проводится разработка хранится под кодом ОКАТО. Коды ГРЗ включены ввиду их наличия в различных рег. номерах объектов (напр., на остановках на межрег. маршрутах).
         Код ОКАТО является основным географическим классификаторов на уровне субъекта РФ. При этом совершенно не важно, реализуется ли проект в рамках субъекта РФ или отдельного мун. обр.
         Также через него формируются запросы в Генеральную БД для получения данных об ОТИ и маршрутах в представления (view).
   - [ ] таблица urban_agglos: список городских агломераций в составе субъекта РФ (используется, в основном, в рамках Национального проекта);
         Таблица городских агломераций с аббревиатурой для однозначного определения перечня в рамках нацпроекта.
   - [ ] таблица agglos_municipalities*: список муниципальных образований в составе городских агломераций.
         Однозначное определение состава городских агломераций в рамках нац. проекта. Использовать ответы субъектов РФ в справках 2020-2021 гг.
   - [ ] таблица srd_cat: таблица категорий улиц и дорог;
         Стандартные категории а. дорог для стандартизации обозначения в документах.
   - [ ] таблица act_type: таблица типов мероприятий.
         Стандартные типы мероприятий для стандартизации обозначения типа в отчетных документах.
5) административные таблицы: в целом, сведения о проектах и отчетной документации по проектам. Содержит административную информацию, однако через атрибуты проекта и документов осуществляется привязка 
   территориальная привязка мероприятий и показателей: через идентификатор проекта и ОКАТО региона. Через идентификаторы документации идет привязка к конкретному документы (необходимо для расчета финансирования 
   и результатов реализации в составе отчетов).

## <a id="titl2">Нижний уровень - Проектные базы данных</a>

- [x] 1) таблица infra_objects: информация о существующих ОТИ на территории разработки. Сюда включаются данные, полученные от заказчиков и из открытых документов по объектам разработки, т.е. перечни дорог, 
       параметры станций, вокзалов и т.п. Нужна для формирования общей базы данных, а также для однозначной привязки мероприятий в случае реконструкций.
- [x] 2) таблица ptv_routes: информация о маршрутной сети. Изначально предполагается использование для информации о существующих маршрутах. Но при необходимости может быть использована для моделирования 
       перспективных маршрутных сетей. В составе программы обработки реестра есть функционал расчет пробегов по дням недели и месяцам при наличии хотя бы базовых графиков (дни обслуживания). Принципиально то 
       же самое, что и аналогичная таблица в Генеральной БД, но на уровне объекта проектирования.
       ВАЖНО: маршрутом считается не полностью все данные, которые есть в реестрах, а непосредственно линейный объект, связывающий остановочные пункты, с уникальными характеристиками: протяженность, 
       обслуживающая организация, режим обслуживания (частота). Подвижной состав включается в другую таблицу данных.
- [x] 3) таблица ptv_vehs: информация о подвижном составе. То же самое, что и ptv_vehs в Генеральной БД, но уже на уровне объекта проектирования.
- [x] 4) таблица action_plan: информация о мероприятиях в составе отчетных программ мероприятий. Должна быть только 1(!) таблица мероприятий по 1 проекту вне зависимости от количества отчетных документов. Т.е. 
       речь идет об ЕДИНОМ перечне по объекту проектирования. Все задачи по разделению расчетов по документам решаются через настройку запросов.
- [ ] 5) таблица idxs_project: таблица показателей реализации проектных предложений. По сути, содержит, в основном, базовые показатели-результаты мат. моделирования, что должно обеспечить общую доступность и 
       единый подход к оценке эффективности. Остальные показатели (при необходимости) можно добавлять в качестве доп. атрибутов. Но указанные в стандартной таблице - обязательные (для моделистов).
- [ ] 6) таблица ГИС-слоев (6 таблиц): т.к. речь идет об единой структуре данных, то слои ГИС должны быть тоже унифицированы. Разделение только для существующих и перспективных объектов (ввиду доп. атрибутов 
       стоимости, года, варианта реализации для перспективы). На уровне ГИС-слоев разделение по сущностям - только по базовой форме объекта: точечные объекты, линейные и полигональные. Отказаться от 
       функциональной классификации.
